<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Retro Quiz</title>
<link rel="stylesheet" href="assets/css/quizz.css">
<link rel="stylesheet" href="quizz/3dec/style.css">
</head>
<body>

<div id="slides" class="slide-container">
    <div id="intro" class="slide"> ... </div>
    <div id="menu" class="slide"> ... </div>
    <div id="question_title" class="slide"> ... </div>
    <div id="question" class="slide"> ... </div>
    <div id="correction" class="slide"> ... </div>
    <div id="score" class="slide"> ... </div>
    <div id="result" class="slide"> ... </div>
    <div id="outro" class="slide"> ... </div>
</div>

<script src="quizz/3dec/data.js" charset="utf-8" ></script>
<script src="src/model.js" charset="utf-8" ></script>
<script src="src/control.js" charset="utf-8" ></script>
<script src="src/view.js" charset="utf-8" ></script>


<script>


// ------------------------------
// QUIZ ENGINE
// ------------------------------

let selected_answer = 0;
let locked = false;
let valid = true


// ------------------------------
// SNOW GENERATOR
// ------------------------------
function createSnow() {
    const snowContainer = document.getElementById("snow");
    const total = 40;  // number of flakes (tune this)

    for (let i = 0; i < total; i++) {
        const flake = document.createElement("div");
        flake.className = "snowflake";
        flake.innerHTML = "❄";

        // Random size
        const size = Math.random() * 12 + 10;
        flake.style.fontSize = size + "px";

        // Random horizontal starting point
        flake.style.left = Math.random() * 100 + "vw";

        // Random animation duration
        flake.style.animationDuration = (4 + Math.random() * 6) + "s";

        // Random animation delay
        flake.style.animationDelay = Math.random() * 5 + "s";

        snowContainer.appendChild(flake);
    }
}

var game = new Game()
var quizz = new Quizz()

quizz.load(QUIZZ_DATA)
//quizz.shuffle_answers()


// game. add sound
var game_sounds = {
    correct:new Audio('assets/audio/correct.mp3'),
    incorrect:new Audio('assets/audio/incorrect.mp3')
}


game.add_state("intro",function(id){
    quizz.restart()

    document.getElementById(id).innerHTML = "";
    addCenteredImage(id,"quizz/3dec/splash_screen.png",)

})
game.add_state("menu",function(id){},function(id){})

// QUESTION VIEW
game.add_state("question_title",function(id){

    document.getElementById(id).innerHTML = "";
    if(quizz.is_last_question()){
        game.apply_state("result")
        return
    }

    // iterate 
    quizz.next_question();
    quizz.next_team();

    const question = quizz.get_current_question()
    const team = quizz.get_current_team()
    const card = document.createElement("div");
    card.className = "card";
    card.id = "card";
    
    card.innerHTML = `
    <h1>Question ${quizz.get_current_question_number()} / ${quizz.get_question_total()} </h1>
    <h1>pour équipe ${team.name}</h1>
    `;

    document.getElementById(id).appendChild(card);
    
    selected_answer = 0;

},function(id){


})

game.add_state("question",function(id){

    const question = quizz.get_current_question()
    const team = quizz.get_current_team()
    const answers = question.answers
    
    const card = document.createElement("div");
    card.className = "card";
    card.id = "card";
    
    card.innerHTML = `
    <h1>question pour équipe ${team.name}</h1>
    <h1>${question.text}</h1>
        ${answers.map((a, i) =>
        `<div class="answer ${i === 0 ? "selected" : ""}" data-i="${i}">
                <span class = "question_number" > ${i+1} </span> ${a.text}
            </div>`
            ).join("")}
            `;

    document.getElementById(id).innerHTML = "";
    document.getElementById(id).appendChild(card);
    
    selected_answer = 0;


    
},function(id){

    console.log(`select ${selected_answer} `)

    document.querySelectorAll(".answer").forEach(el => el.classList.remove("selected"));
    document.querySelectorAll(".answer")[selected_answer].classList.add("selected");
})

// CORRECTION VIEW
game.add_state("correction", function(id) {

    const question = quizz.get_current_question();
    const team = quizz.get_current_team();
    
    const card = document.createElement("div");
    card.className = "card";
    card.id = "card";
    
    const chosen = question.answers[selected_answer];
    valid = chosen.valid;

    if (chosen.valid != undefined) {
        if (valid) {
            quizz.increment_score();
            game_sounds.correct.play();
        } else {
            game_sounds.incorrect.play();
        }
    }

    const correction_text = question.correction;
    const valid_answer = question.get_valid_answer()

    let verdict_text = valid ? "bonne réponse !" : "mauvaise réponse !";

    // ⭐ SET CARD BACKGROUND BASED ON VALIDITY
    card.style.backgroundColor = valid ? "#82e082" : "#ff8b8b";
    card.style.transition = "background-color 0.3s ease";

    card.innerHTML = `
        <h1>${verdict_text}</h1>
        <h1>${valid_answer}</h1>
        <h1>${correction_text}</h1>
    `;

    document.getElementById(id).innerHTML = "";
    document.getElementById(id).appendChild(card);


    locked = false;

}, function(id){});

game.add_state("score",function(id){

    const card = document.createElement("div");
    card.className = "card";
    card.id = "card";

    card.innerHTML = `
        <h1>${render_scores_podium()}</h1>
    `;

    document.getElementById(id).innerHTML = "";
    document.getElementById(id).appendChild(card);

    locked = false;

},function(id){

})
game.add_state("result",function(id){

    const card = document.createElement("div");
    card.className = "card";
    card.id = "card";

    const winners = quizz.get_winners()
    if(winners.length>1){
        winner = " Egalité "+[winners].join("  ")
    }else{
        winner = "L' équipe "+winners[0]+" a gagné !"
    }

    card.innerHTML = `
        <h1>${winner}</h1>
        <h1>${render_scores_podium()}</h1>
    `;

    document.getElementById(id).innerHTML = "";
    document.getElementById(id).appendChild(card);

    locked = false;

},function(id){

})




game.add_state("outro",function(id){

})
game.connect_states("intro","menu")
game.connect_states("menu","question_title")
game.connect_states("question_title","question")
game.connect_states("question","correction")
game.connect_states("correction","score")
// TODO add conditionnal states that go to state A or B 
game.connect_states("score","question_title")
game.connect_states("result","outro")
game.connect_states("outro","intro")

game.apply_state("intro")

/*


    if (e.key === "ArrowDown") {
        selected = (selected + 1) % items.length;
        game_sounds.bloub.play()
        updateSelection();
    }

    if (e.key === "ArrowUp") {
        selected = (selected - 1 + items.length) % items.length;
        game_sounds.corbloubrect.play()
        updateSelection();
    }

*/

document.addEventListener("keydown", (e) => {
    if (locked) return
    const items = document.querySelectorAll(".answer");
    if (e.key === "ArrowDown") {
        selected_answer = (selected_answer + 1) % items.length;
        console.log("DOWN")
        game.update()
    }    
    
    
    if (e.key === "ArrowUp") {
        selected_answer = (selected_answer - 1 + items.length) % items.length;
        console.log("UP")
        game.update()
    }
    
    if (e.key === "ArrowLeft") {
        console.log("LEFT")
        
        game.update()
    }    
    if (e.key === "ArrowRigth") {
        console.log("RIGTH")
        game.update()
    }
    if (e.key === "Enter") {
        console.log("ENTER")
        game.next_state()
    }
});



</script>

</body>
</html>
